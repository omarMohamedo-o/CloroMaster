name: Build and Push Images

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push chloromaster-nginx
              uses: docker/build-push-action@v4
              with:
                  context: ./nginx
                  push: true
                  tags: |
                      ${{ secrets.DOCKERHUB_NAMESPACE }}/chloromaster-nginx:latest
                      ${{ secrets.DOCKERHUB_NAMESPACE }}/chloromaster-nginx:${{ github.sha }}

            # Optional: build custom redis image if you maintain one at ./docker/redis
            - name: Build and push chloromaster-redis (optional)
              if: ${{ always() }}
              run: |
                  if [ -d "./docker/redis" ]; then
                    echo "Custom redis directory found, building and pushing..."
                    docker build -t ${{ secrets.DOCKERHUB_NAMESPACE }}/chloromaster-redis:latest ./docker/redis
                    echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
                    docker push ${{ secrets.DOCKERHUB_NAMESPACE }}/chloromaster-redis:latest
                  else
                    echo "No custom redis folder present; skipping."
                  fi
