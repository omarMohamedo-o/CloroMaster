# ==========================================
# ChloroMaster - Unified Docker Compose
# ==========================================
# Profiles:
#   default: Frontend + Backend (SQLite) + Nginx
#   dev: Add SQL Server + Redis for backend development
#   monitoring: Add Prometheus + Grafana for monitoring
#
# Usage:
#   docker compose up -d                    # Production stack
#   docker compose --profile dev up -d      # With SQL Server + Redis
#   docker compose --profile monitoring up -d  # With monitoring
#   docker compose --profile dev --profile monitoring up -d  # Everything
# ==========================================

services:
  # ==========================================
  # Frontend Service (React Application)
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    image: chloromaster/frontend:latest
    container_name: chloromaster-frontend
    restart: unless-stopped
    networks:
      - chloromaster-network
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # Backend API Service (.NET 8)
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: final
    image: chloromaster/backend:latest
    container_name: chloromaster-backend
    restart: unless-stopped
    networks:
      - chloromaster-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/chloromaster.db
    volumes:
      - backend_data:/app/data:rw
      - backend_logs:/app/logs:rw
    user: "1001:1001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # Nginx Reverse Proxy & Load Balancer
  # ==========================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: chloromaster/nginx:latest
    container_name: chloromaster-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    networks:
      - chloromaster-network
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /var/run:size=2M,mode=1777
      - /var/cache/nginx:size=256M,mode=1777
      - /var/log/nginx:size=32M,mode=1777
      - /tmp:size=64M,mode=1777
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # Redis Cache (Production)
  # ==========================================
  redis:
    build:
      context: ./redis
      dockerfile: Dockerfile
    image: chloromaster/redis:latest
    container_name: chloromaster-redis
    restart: unless-stopped
    networks:
      - chloromaster-network
    volumes:
      - redis_data:/data:rw
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # Development Services (SQL Server)
  # Profile: dev
  # ==========================================
  sqlserver:
    profiles: ["dev"]
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: chloromaster-sqlserver
    restart: unless-stopped
    environment:
      - ACCEPT_EULA=Y
      # Use environment variables to avoid hardcoding secrets in source.
      # Set SA_PASSWORD in your environment or in a local .env file.
      - SA_PASSWORD=${SA_PASSWORD:-REPLACE_WITH_SECURE_PASSWORD}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - chloromaster-network
    healthcheck:
      # Healthcheck uses the same SA_PASSWORD from environment interpolation.
      # Note: docker-compose does not expand variables inside the healthcheck command
      # in all versions; using a simple TCP check is more portable. If a password
      # based check is required, ensure the environment is available to Docker.
      test: ["CMD", "bash", "-c", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P \"${SA_PASSWORD:-REPLACE_WITH_SECURE_PASSWORD}\" -Q 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # Monitoring Services (Prometheus + Grafana)
  # Profile: monitoring
  # ==========================================
  prometheus:
    profiles: ["monitoring"]
    build:
      context: ./monitoring/prometheus
      dockerfile: Dockerfile
    image: chloromaster/prometheus:latest
    container_name: chloromaster-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
    networks:
      - chloromaster-network
    depends_on:
      - backend
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    profiles: ["monitoring"]
    build:
      context: ./monitoring/grafana
      dockerfile: Dockerfile
    image: chloromaster/grafana:latest
    container_name: chloromaster-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - chloromaster-network
    depends_on:
      - prometheus
    environment:
      # Use environment interpolation to prevent checking secrets into repo.
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-REPLACE_WITH_SECURE_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-clock-panel,grafana-worldmap-panel
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==========================================
# Networks Configuration
# ==========================================
networks:
  chloromaster-network:
    name: chloromaster-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    driver_opts:
      com.docker.network.bridge.name: br-chloromaster
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: "1500"

# ==========================================
# Volumes Configuration
# ==========================================
volumes:
  backend_data:
    name: chloromaster-backend-data
    driver: local
  backend_logs:
    name: chloromaster-backend-logs
    driver: local
  nginx_cache:
    name: chloromaster-nginx-cache
    driver: local
  sqlserver_data:
    name: chloromaster-sqlserver-data
    driver: local
  redis_data:
    name: chloromaster-redis-data
    driver: local
  prometheus_data:
    name: chloromaster-prometheus-data
    driver: local
  grafana_data:
    name: chloromaster-grafana-data
    driver: local